**EC2 + PM2 + nginx デプロイ記録（2025-11-15）**

##  学習日時

2025年11月15日

## ✅ 結論

Phase‑B（EC2 上で Next.js を pm2 + nginx で公開し、systemd による自動復元まで確認）は学習目的のコア要件を満たして完了と判断できます。残作業はセキュリティ（Secrets 管理）や監視の整備です。

##  概要（実施したこと）

- EC2 インスタンスを起動し、Node.js 20・nginx・pm2 をインストール。
- リポジトリをクローンして `npm ci` → `npm run build` を実行。
- `pm2` でアプリをデーモンとして起動し `pm2 save`、`pm2 startup systemd` で systemd ユニットを作成。
- `.pm2` の所有権問題を解消して systemd による自動復元を正常化。
- nginx をリバースプロキシとして設定し、外部から `HTTP/1.1 200 OK` を確認。

##  詳細（主要コマンドと意味）

以下、作業中に実行した主要コマンドを「何をするか」「なぜ必要か」「確認ポイント」「失敗しやすい点」の順で整理します。

### サーバ準備（Node / nginx のインストール）

- コマンド:
  - `curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -`
  - `sudo yum install -y nodejs nginx`
- 何をするか: Node.js と nginx を導入する。
- なぜ必要か: Next.js のビルド/実行に Node が必要。nginx は外部からの HTTP を受け内部サーバへ中継する。
- 確認ポイント: `node -v`, `nginx -v` が期待値を返す。
- 失敗しやすい点: リポジトリの設定やネットワークで失敗する。

### pm2 のインストールとアプリ起動

- コマンド:
  - `sudo npm install -g pm2`
  - `pm2 start npm --name aws-weather -- start`
  - `pm2 save`
- 何をするか: pm2 を使って `npm start` をデーモンとして起動し、現状のプロセスリストを保存する。
- なぜ必要か: pm2 はプロセスマネージャとして自動再起動・ログ管理を行い、`pm2 save` は再起動復元用の dump を作る。
- 確認ポイント: `pm2 status` で `aws-weather` が `online`、`~/.pm2/dump.pm2` が存在する。
- 失敗しやすい点: root で pm2 を操作すると `~/.pm2` の所有者が root になり systemd 連携で問題が起きる。

### pm2 と systemd の連携

- コマンド:
  - `pm2 startup systemd`
  - 出力に従い `sudo systemctl start pm2-ec2-user` / `sudo systemctl enable pm2-ec2-user`
- 何をするか: pm2 用の systemd ユニットを生成し、ブート時に pm2 を起動する仕組みを作る。
- なぜ必要か: インスタンス再起動時に自動でプロセスを復元させるため。
- 確認ポイント: `/etc/systemd/system/pm2-ec2-user.service` に `User=ec2-user` と `PIDFile` 設定があること。`systemctl status` が `active` を返すこと。
- 失敗しやすい点: `.pm2` の所有権不一致により systemd が PID を受け付けない。

### 所有権／PID ファイルの修正

- コマンド:
  - `sudo chown -R ec2-user:ec2-user /home/ec2-user/.pm2`
  - `sudo -u ec2-user pm2 save`
- 何をするか: `.pm2` を正しいユーザー所有に戻し、pm2 が PID を作れるようにする。
- なぜ必要か: systemd はユニットの User とプロセス所有者の一致を期待しているため。
- 確認ポイント: `ls -la /home/ec2-user/.pm2`、`/home/ec2-user/.pm2/pm2.pid` の存在。
- 失敗しやすい点: root のまま放置して復旧できないこと。

### nginx のリバースプロキシ設定

- コマンド（例）:
  - `sudo tee /etc/nginx/conf.d/aws-weather.conf > /dev/null <<'EOF' ... EOF`
  - `sudo nginx -t && sudo systemctl reload nginx`
- 何をするか: nginx をフロントに置き、HTTP リクエストを `127.0.0.1:3000` に転送する。
- なぜ必要か: 静的資産の配信や TLS の追加など将来の運用上有利。
- 確認ポイント: `curl -I http://<PUBLIC_IP>/` が `200 OK` を返す。
- 失敗しやすい点: セキュリティグループ/ポートや設定ミス。

### IMDSv2（メタデータ取得）

- コマンド:
  - `TOKEN=$(curl -s -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")`
  - `curl -s -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/public-ipv4`
- 何をするか: IMDSv2 トークンを使いメタデータ（public-ipv4 等）を安全に取得する。
- なぜ必要か: IMDSv2 のトークン方式はセキュリティ的に推奨されているため、従来のコールが空になる場合に必要。
- 確認ポイント: public IPv4 が返ること（例: `13.115.241.116`）。
- 失敗しやすい点: IMDSv2 が無効/制限されている場合やトークン取得が失敗する場合。

### 再起動テスト

- コマンド:
  - `sudo systemctl enable pm2-ec2-user`
  - `sudo reboot`
- 何をするか: ユニットを有効化し、実際に再起動して自動復元を検証する。
- 確認ポイント: 再接続後に `sudo systemctl status pm2-ec2-user` が `active`、`pm2 status` が `online`。

## ✅ 補足（学び・注意点）

- pm2 と systemd の連携で最も重要なのは所有権と `pm2 save`。pm2 を root で操作しないこと。
- API キーは長期的には SSM/Secrets Manager に移すこと。ローカル `.env.local` は git に入れない。

## 次の推奨アクション（短期）

1. `OPENWEATHER_API_KEY` を AWS SSM Parameter Store の `SecureString` に移行し、pm2 起動時に注入する手順を実施する（支援可能）。
2. CloudWatch Logs にアプリログを送る設定を追加する。

---

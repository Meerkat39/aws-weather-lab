# S3+SSM ベースのデプロイ vs SSH 直接デプロイ の比較

## 📅 学習日時

2025 年 11 月 19 日

## ✅ 結論

- セキュリティが厳しい環境やホスト型 GitHub Actions runner の送信元 IP が制御できない場合は、S3 にビルド成果物を置き、SSM の `SendCommand` で EC2 に展開するフローが現実的で安全。インバウンドのポート開放（SSH）を避けられるのが最大の利点。
- 一方、SSH 直接デプロイは単純でセットアップが少ないため小規模な環境や手元での開発リリースに便利だが、運用時のセキュリティ制約（鍵管理、SG の開放、ランナーの IP ホワイトリスト化）が障害になりやすい。

## 🧠 詳細

以下は「どこで」「何の手順が」「どの順番で」行われるかをわかりやすく比較したもの。各手順の前提（権限や設定）、失敗しやすい点、確認ポイントも併せて記載します。

---

**A) S3 + SSM ベースのデプロイ（推奨運用フロー）**

- 前提

  - GitHub Actions に S3 PutObject と SSM:SendCommand の権限があること（短期キー、OIDC を推奨）。
  - EC2 インスタンスに Amazon SSM Agent が稼働しており、インスタンスプロファイルが `s3:GetObject` を持つこと。
  - S3 バケットと実行スクリプト（`/home/ec2-user/.../deploy-from-s3.sh`）が存在すること。

- 手順（順序）

  1. Actions: ビルド（`npm run build` / `next build`）→ `release.tgz` を作成。
  2. Actions: S3 に `release.tgz` をアップロード（`aws s3 cp`）。
  3. Actions: `ssm:SendCommand` を呼び出し、ターゲットに EC2 の `InstanceId` を指定。コマンド本文で `deploy-from-s3.sh <bucket> <key> [app-name]` を実行。
  4. EC2（SSM Agent）: `deploy-from-s3.sh` が実行され、S3 からダウンロード、展開、`chown`、`npm ci`（または同梱 node_modules を配置）、`ln -sfn` で `current` 切替、`pm2 restart` を実行。
  5. Actions: SSM の `CommandId` をポーリングして終了コードを確認し、成功/失敗を判定。

- 失敗しやすい点 / チェックポイント

  - EC2 インスタンスロールに `s3:GetObject` がない → スクリプトが S3 ダウンロードで失敗。
  - SSM ドキュメント実行のタイムアウト（長時間の `npm ci` 等で InProgress→ タイムアウト）→ スクリプトを短く分割するか、`npm ci` を非同期化してログ収集する設計にする。
  - 権限ミスマッチ（Actions 側の IAM が `ssm:SendCommand` を持っていない）→ SendCommand が AccessDenied。

- 確認コマンド / 検証
  - S3 にファイルがあるか: `aws s3 ls s3://<bucket>/<key>`
  - SSM Agent 状態: `sudo systemctl status amazon-ssm-agent`
  - 手動デバッグ（EC2）: `sudo bash -x /home/ec2-user/deploy-from-s3.sh <bucket> <key>` → `/var/log/aws-weather-deploy.log` を確認

---

**B) SSH 直接デプロイ（従来フロー）**

- 前提

  - EC2 のセキュリティグループで GitHub Actions runner の IP を許可するか、Secrets に SSH 鍵を安全に格納する必要がある。
  - ランナーから EC2 に SSH 接続可能であること。

- 手順（順序）

  1. Actions: ビルドして成果物（release.tgz, または `next build` と `node_modules` を含める）を生成。
  2. Actions: `scp`/`rsync` で EC2 に成果物を転送（SSH）。
  3. Actions または EC2 の起動スクリプト: SSH 経由でリモートコマンド（展開、`npm ci`、`pm2 restart`）を実行。

- 失敗しやすい点 / チェックポイント

  - セキュリティグループで GitHub 実行元（ホスト型 runner）の IP をホワイトリスト化できない → 接続失敗。
  - SSH 鍵の管理リスク（鍵を Actions Secrets に入れること自体が懸念になる）。
  - 組織ポリシーで外部からの SSH を許可できないケースがある。

- 確認コマンド / 検証
  - Actions の実行ログで `scp`/`ssh` が成功しているか確認。
  - EC2 側で `ls -la <deploy-dir>` と `pm2 status` を確認。

---

## 推奨と運用上の判断基準

- セキュリティ重視／本番運用なら **S3+SSM** を推奨。
- 単発の開発リリースや VPN 内の閉じた環境などでランナー IP 制御が可能なら **SSH** の方が簡単な場合がある。
- 長期的には GitHub OIDC を用いて Actions に最小権限で S3/SSM を渡す方式が最も安全で推奨される。

## トラブルシュートの短い手引き

- S3 ダウンロード失敗: EC2 のインスタンスプロファイルに `s3:GetObject` 付与を確認。
- SSM 実行がタイムアウト: SSM エージェントログ（`/var/log/amazon/ssm/`）を確認し、スクリプトを短時間で終わる単位に分割する。
- npm の権限エラー: 展開後に `chown -R ec2-user:ec2-user <release_dir>` を行い、`npm ci` を `sudo -u ec2-user` で実行する。

## チェックリスト（導入時）

- [ ] Actions に S3 Put と SSM SendCommand の最小ポリシーを付与
- [ ] EC2 に SSM Agent と S3 Get の権限を与えたインスタンスプロファイルを割り当て
- [ ] `deploy-from-s3.sh` を冪等化（既存プロセス削除、chown、node_modules 処理を含む）
- [ ] Actions でビルド時に `NEXT_PUBLIC_COMMIT_SHA` 等を埋め込み検証ポイントを設ける（`/api/version` など）

---

## 参考（今回のリポジトリでの実装ポイント）

- `scripts/deploy-from-s3.sh`: S3 から取得、展開、`chown`, `npm ci`, symlink, pm2 再起動 を行うスクリプト。
- `scripts/full-reset-and-deploy.sh`: バックアップ → クリーン →`deploy-from-s3.sh` 呼び出しの自動化スクリプト。
- `.github/workflows/deploy-ec2.yml`: build→S3 upload→SSM send-command→poll のフローを実装。

---

## 次に学ぶ/改善すること（短期）

1. Actions 側を OIDC に切り替えて長期鍵を使わない構成へ移行する。
2. SSM 実行時間を短縮するため、`npm ci` を事前に runner 側で済ませる（node_modules をアーカイブして S3 に置く戦略）か、EC2 側にキャッシュを持たせる。
3. CloudWatch Logs / Healthcheck を導入してデプロイ後の自動検証を入れる。

---

作成者: aws-weather-lab ハンズオン
